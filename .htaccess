RewriteEngine On

# Global CORS preflight handling for all API routes
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ cors_handler.php [QSA,L]

# API Routes
RewriteRule ^api/auth/(.*)$ api/auth.php/$1 [QSA,L]
RewriteRule ^api/user/(.*)$ api/user.php/$1 [QSA,L]
RewriteRule ^api/forms/?(.*)$ api/forms.php [QSA,L]
RewriteRule ^api/admin/dsa-applications/?(.*)$ api/admin/dsa-applications.php [QSA,L]
RewriteRule ^api/admin/(.*)$ api/admin.php/$1 [QSA,L]
RewriteRule ^api/branches/?(.*)$ api/branches.php [QSA,L]
RewriteRule ^api/bankers/?(.*)$ api/bankers.php [QSA,L]
RewriteRule ^api/contact/?$ api/contact.php [QSA,L]
RewriteRule ^api/validate/?$ api/validate.php [QSA,L]
RewriteRule ^api/ai-config/?$ api/ai-config.php [QSA,L]
RewriteRule ^api/blogs/?(.*)$ api/blogs.php [QSA,L]
RewriteRule ^api/courses/?(.*)$ api/courses.php [QSA,L]
RewriteRule ^api/leads/?(.*)$ api/leads.php [QSA,L]
RewriteRule ^api/enrollments/?(.*)$ api/enrollments.php [QSA,L]
RewriteRule ^api/settings/?(.*)$ api/settings.php [QSA,L]
RewriteRule ^api/careers/?(.*)$ api/careers.php [QSA,L]
RewriteRule ^api/loan-onboarding-result/?(.*)$ api/loan-onboarding-result.php [QSA,L]
RewriteRule ^api/loan-onboarding-pdf/?(.*)$ api/loan-onboarding-pdf.php [QSA,L]
RewriteRule ^api/loan-application/?(.*)$ api/loan-application.php [QSA,L]
RewriteRule ^api/dsa-registration/?$ api/dsa-registration.php [QSA,L]
RewriteRule ^api/upload-image/?$ api/upload-image.php [QSA,L]

# Serve uploaded images
RewriteRule ^uploads/(.*)$ uploads/$1 [L]

# Security Headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

# Prevent access to sensitive files
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

<Files ~ "\.php$">
    Order allow,deny
    Allow from all
</Files>

# Block access to config and model files directly
RedirectMatch 403 ^/backend/(config|models|middleware)/.*$